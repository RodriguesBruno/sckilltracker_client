{% extends "base.html" %}
{% block content %}

<h2 class="withMargin">Replay Recordings</h2>

<div class="mb-3 text-center">
    <input type="text" id="filterInput" class="form-control w-50 mx-auto" placeholder="Filter recordings by keyword...">
</div>

<div class="video-gallery" id="videoGallery">
    {% for video in video_files %}
        <div class="video-container withMargin" data-filename="{{ video|lower }}">
            <h5 class="text-info mb-2">{{ video }}</h5>

            <video controls preload="none" data-src="{{ url_for('serve_video', filename=video) }}">

                Your browser does not support the video tag.
            </video>

            <div class="mt-3 text-end">
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li>
                            <a href="#" class="dropdown-item rename-toggle" data-target="rename-{{ loop.index }}">
                                Rename
                            </a>
                        </li>
                        <li>
                            <form action="/recordings_controller/delete_video" method="post" onsubmit="return confirm('Are you sure you want to delete this video?');">
                                <input type="hidden" name="filename" value="{{ video }}">
                                <button type="submit" class="dropdown-item text-danger">Delete</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>

            <form action="/recordings_controller/rename_video" method="post" class="rename-form mt-2" id="rename-{{ loop.index }}" style="display: none;">
                <input type="hidden" name="old_name" value="{{ video }}">
                <div class="input-group input-group-sm">
                    <input type="text" name="new_name" class="form-control" placeholder="New filename (with .mp4)" required>
                    <button type="submit" class="btn btn-outline-primary">Rename</button>
                </div>
            </form>
        </div>
    {% else %}
        <p>No videos found.</p>
    {% endfor %}
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        let openRenameForm = null;

        // Toggle Rename Form
        document.querySelectorAll('.rename-toggle').forEach(toggle => {
            toggle.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();

                const form = document.getElementById(toggle.dataset.target);
                const input = form.querySelector('input[name="new_name"]');

                if (openRenameForm && openRenameForm !== form) {
                    openRenameForm.style.display = 'none';
                }

                const isVisible = form.style.display === 'block';
                form.style.display = isVisible ? 'none' : 'block';
                openRenameForm = isVisible ? null : form;

                if (!isVisible && input) {
                    input.value = '';
                    input.focus();
                }
            });
        });

        // Close dropdowns and rename forms when clicking outside
        document.addEventListener('click', (event) => {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (!menu.closest('.btn-group').contains(event.target)) {
                    const toggle = menu.previousElementSibling;
                    bootstrap.Dropdown.getInstance(toggle)?.hide();
                }
            });

            if (openRenameForm && !openRenameForm.contains(event.target)) {
                openRenameForm.style.display = 'none';
                openRenameForm = null;
            }
        });

        // Filter videos by keyword
        const filterInput = document.getElementById("filterInput");
        const videoContainers = document.querySelectorAll("#videoGallery .video-container");

        filterInput.addEventListener("input", () => {
        const keyword = filterInput.value.toLowerCase().trim();

        videoContainers.forEach(container => {
            const filename = container.dataset.filename;
            if (filename.includes(keyword)) {
                container.style.display = "flex";
            } else {
                container.style.display = "none";
            }
        });
        });
    });

        document.addEventListener('DOMContentLoaded', () => {
        const videos = document.querySelectorAll('video[data-src]');

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const video = entry.target;
                    if (!video.querySelector('source')) {
                        const source = document.createElement('source');
                        source.src = video.dataset.src;
                        source.type = 'video/mp4';
                        video.appendChild(source);
                        video.load();
                    }
                    observer.unobserve(video);
                }
            });
        }, {
            rootMargin: '200px', // Start loading before fully in view
            threshold: 0.1
        });

        videos.forEach(video => observer.observe(video));
    });
</script>

{% endblock %}
