{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', path='css/statistics.css') }}">
{% endblock %}

{% block content %}
<div class="content">
  <h2>Statistics</h2>

    <div class="chart-row">
      <div class="chart-container shadowed-chart">
        <div id="killerShipsPlot"></div>
      </div>

      <div class="chart-container shadowed-chart">
        <div id="enemyKillerShipsPlot"></div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container shadowed-chart" style="width:100%">
        <div id="topVictimOrgsPlot"></div>
      </div>
      <div class="chart-container shadowed-chart" style="width:100%">
        <div id="topKillerOrgsPlot"></div>
      </div>
    </div>

  <div class="chart-row">
    <div class="chart-container shadowed-chart">
      <div id="topVictimsPlot"></div>
    </div>

    <div class="chart-container shadowed-chart">
      <div id="topKillersPlot"></div>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-container shadowed-chart">
      <div id="gameModePlot"></div>
    </div>

    <div class="chart-container shadowed-chart">
      <div id="damagePlot"></div>
    </div>
  </div>
  
<div></div>
  <div class="tables">
  <div>
    <h3>Your Kills and Deaths (Day / Week / Month / All)</h3>
    <table class="stats-table" id="playerStatsTable">
    <thead>
      <tr>
        <th>Period</th>
        <th>Kills</th>
        <th>Deaths</th>
        <th>Suicides</th>
        <th>KDR</th>
      </tr>
    </thead>
    <tbody></tbody>
    </table>
  </div>

    <div >
      <div style="width:100%">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <h3 style="margin:0;">Kills vs Deaths (Timeline)</h3>
          <label style="font-size:14px;">
            Period:
            <select id="kdPeriodSelect">
              <option value="week">Week</option>
              <option value="month" selected>Month</option>
              <option value="all">All time</option>
            </select>
          </label>
        </div>
        <div id="kdTimelinePlot"></div>
      </div>
    </div>

</div>

  <div class="tables">
    <div>
      <h3>Top Victims (Day / Week / Month / All)</h3>
      <table id="topVictimsTable" class="stats-table">
        <thead>
          <tr>
            <th>Victim</th><th>Day</th><th>Week</th><th>Month</th><th>All</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div>
      <h3>Top Killers (Day / Week / Month / All)</h3>
      <table id="topKillersTable" class="stats-table">
        <thead>
          <tr>
            <th>Killer</th><th>Day</th><th>Week</th><th>Month</th><th>All</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>


<script>
  async function loadStatistics() {
    try {
      const res = await fetch('/statistics/data');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const layoutDark = {
        template: 'plotly_dark',
        paper_bgcolor: '#1e1e1e',
        plot_bgcolor: '#1e1e1e',
        font: { family: 'Verdana, sans-serif', size: 14, color: '#e0e0e0' }
      };

      const axisCommon = {
        titlefont: { color: '#e0e0e0' },
        tickfont: { color: '#e0e0e0' },
        showline: true,
        linecolor: '#555',
        mirror: true,
        zerolinecolor: '#444',
        tickcolor: '#555'
      };

      // Top Victims (vertical bar)
      Plotly.newPlot('topVictimsPlot', [{
        x: data.top_victims.map(v => v.victim_name),
        y: data.top_victims.map(v => v.count),
        type: 'bar', marker: { color: '#0d6efd' }
      }], Object.assign({
        margin: { b: 80, t: 60 },
        xaxis: { title: 'Victim' },
        yaxis: { title: 'Count' },
        title: 'Top Victims'
        }, axisCommon, layoutDark));

        let shipsData = { most_killed_ships: [], most_dead_ships: [] };
        try {
          const resShips = await fetch('/statistics/ships');
          if (resShips.ok) shipsData = await resShips.json();
        } catch (e) {
          console.warn('Ship aggregates fetch failed', e);
        }

        // Kills by Ship You Flew  (ship_name when YOU are the killer; excludes suicides)
        const killsClean = (shipsData.most_killed_ships || []).filter(
          s => s && typeof s.ship === 'string' && s.ship.trim() !== '-' && s.ship.trim() !== ''
        );

        Plotly.newPlot('killerShipsPlot', [{
          x: killsClean.map(s => s.ship),
          y: killsClean.map(s => s.count),
          type: 'bar', marker: { color: '#2F6542' }
        }], Object.assign({
          margin: { b: 80, t: 60 },
          xaxis: { title: 'Ship Name' },
          yaxis: { title: 'Kills' },
          title: 'Ships YOU were flying when you killed'
        }, axisCommon, layoutDark));

        // Deaths by Zone
        Plotly.newPlot('enemyKillerShipsPlot', [{
          x: shipsData.most_dead_ships.map(s => s.zone),
          y: shipsData.most_dead_ships.map(s => s.count),
          type: 'bar' , marker: { color: '#D77A7D' }
        }], Object.assign({
          margin: { b: 80, t: 60 },
          xaxis: { title: 'Zone' },
          yaxis: { title: 'Deaths' },
          title: 'Zones where YOU died'
        }, axisCommon, layoutDark));

      // Add click handler for Top Victims
      document.getElementById('topVictimsPlot').on('plotly_click', function(eventData) {
        const name = eventData.points[0].x;
        const url = `https://robertsspaceindustries.com/en/citizens/${name}`;
        window.open(url, '_blank');
      });

      // --- Orgs You Kill Most  & Orgs That Kill You Most ---
    try {
      const resOrgs = await fetch('/statistics/orgs');
      if (resOrgs.ok) {
        const orgData = await resOrgs.json();
        const vOrgs = orgData.top_victim_orgs || [];
        const kOrgs = orgData.top_killer_orgs || [];

        // You -> Them
        Plotly.newPlot('topVictimOrgsPlot', [{
          x: vOrgs.map(o => o.org),
          y: vOrgs.map(o => o.count),
          type: 'bar', marker: { color: '#2F6542' }
        }], Object.assign({
          margin: { b: 80, t: 60 },
          xaxis: { title: 'Organization' },
          yaxis: { title: 'Kills' },
          title: 'Organizations YOU kill the most'
        }, axisCommon, layoutDark));

        // Them -> You
        Plotly.newPlot('topKillerOrgsPlot', [{
          x: kOrgs.map(o => o.org),
          y: kOrgs.map(o => o.count),
          type: 'bar', marker: { color: '#D77A7D' }
        }], Object.assign({
          margin: { b: 80, t: 60 },
          xaxis: { title: 'Organization' },
          yaxis: { title: 'Deaths' },
          title: 'Organizations that kill YOU the most'
        }, axisCommon, layoutDark));
      } else {
        console.warn('Failed to load org stats', resOrgs.status);
      }
    } catch (e) {
      console.warn('Org aggregates fetch failed', e);
    }

async function drawKDTimeline(period = "month") {
  try {
    const resTL = await fetch(`/statistics/timeline?period=${encodeURIComponent(period)}`);
    if (!resTL.ok) throw new Error(`HTTP ${resTL.status}`);
    const tdata = (await resTL.json()).series || [];
    const dates = tdata.map(r => r.date);
    const kills = tdata.map(r => r.kills);
    const deaths = tdata.map(r => r.deaths);

    Plotly.newPlot('kdTimelinePlot', [
      { x: dates, y: kills, marker: { color: '#2F6542'}, type: 'scatter', mode: 'lines+markers', name: 'Kills' },
      { x: dates, y: deaths, marker: { color: '#D77A7D'}, type: 'scatter', mode: 'lines+markers', name: 'Deaths' }
    ], Object.assign({
      margin: { b: 80, t: 40 },
      xaxis: { title: 'Date' },
      yaxis: { title: 'Count' }
    }, axisCommon, layoutDark));
  } catch (e) {
    console.warn('Timeline fetch failed', e);
  }
}
      // Top Killers (vertical bar)
      Plotly.newPlot('topKillersPlot', [{
        x: data.top_killers.map(k => k.killer_name),
        y: data.top_killers.map(k => k.count),
        type: 'bar', marker: { color: '#0d6efd' }
      }], Object.assign({
        margin: { b: 80, t: 60 },
        xaxis: { title: 'Killer' },
        yaxis: { title: 'Count' },
        title: 'Top Killers'
        }, axisCommon, layoutDark));

      // Add click handler for Top Killers
      document.getElementById('topKillersPlot').on('plotly_click', function(eventData) {
        const name = eventData.points[0].x;
        const url = `https://robertsspaceindustries.com/en/citizens/${name}`;
        window.open(url, '_blank');
      });

      // Kills by Game Mode (pie)
      Plotly.newPlot('gameModePlot', [{
        labels: data.kills_by_game_mode.map(m => m.game_mode),
        values: data.kills_by_game_mode.map(m => m.count),
        type: 'pie', textinfo: 'label+percent', hole: 0.4
      }], Object.assign({
        margin: { b: 40, t: 100 },
        title: 'Kills/Game Mode'
        }, axisCommon, layoutDark));

      // Damage Distribution (donut)
      Plotly.newPlot('damagePlot', [{
        labels: data.damage_type_distribution.map(d => d.damage),
        values: data.damage_type_distribution.map(d => d.count),
        type: 'pie', textinfo: 'label+percent', hole: 0.4
      }], Object.assign({
        margin: { b: 40, t: 100 },
        title: 'Damage Type Distribution'
        }, axisCommon, layoutDark));


      // Populate Top Victims Table
      const vtBody = document.querySelector('#topVictimsTable tbody');
      data.top_victims_table.forEach(row => {
        const tr = document.createElement('tr');
        ['victim','day','week','month','all'].forEach(key => {
          const td = document.createElement('td');
          if (key === 'victim') {
            td.innerHTML = `<a href="https://robertsspaceindustries.com/en/citizens/${row[key]}" target="_blank">${row[key]}</a>`;
          } else {
            td.textContent = row[key];
          }
          tr.appendChild(td);
        });
        vtBody.appendChild(tr);
      });

      // Populate Top Killers Table
      const ktBody = document.querySelector('#topKillersTable tbody');
      data.top_killers_table.forEach(row => {
        const tr = document.createElement('tr');
        ['killer','day','week','month','all'].forEach(key => {
          const td = document.createElement('td');
          if (key === 'killer') {
            td.innerHTML = `<a href="https://robertsspaceindustries.com/en/citizens/${row[key]}" target="_blank">${row[key]}</a>`;
          } else {
            td.textContent = row[key];
          }
          tr.appendChild(td);
        });
        ktBody.appendChild(tr);
      });

      // Populate Player Kills/Deaths By Period Table
      const periods = ['day', 'week', 'month', 'all'];
      const pBody = document.querySelector('#playerStatsTable tbody');
      const pdata = data.player_kills_deaths_by_period;

      periods.forEach(period => {
        const row = pdata[period];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${period.charAt(0).toUpperCase() + period.slice(1)}</td>
          <td>${row.kills}</td>
          <td>${row.deaths}</td>
          <td>${row.suicides}</td>
          <td>${row.kdr}</td>
        `;
        pBody.appendChild(tr);
      });

    const kdSelect = document.getElementById('kdPeriodSelect');
    if (kdSelect) {
      kdSelect.addEventListener('change', () => drawKDTimeline(kdSelect.value));
      drawKDTimeline(kdSelect.value); // initial
    }

    } catch (err) {
      console.error('Failed to load statistics:', err);
    }
  }
  document.addEventListener('DOMContentLoaded', loadStatistics);

</script>

{% endblock %}
