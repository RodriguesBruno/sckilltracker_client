{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', path='css/index.css') }}">
{% endblock %}


{% block content %}

    <div id="top-panel">
        <div class="player-card">
            <div class="status-player-card-content" style="display: flex; align-items: flex-start; gap: 20px;">
            <div>
                <img id="pilot-icon"
                     src="{{ pilot_icon_url if pilot_icon_url != '-' else '' }}"
                     alt="Player icon"
                     width="124"
                     height="124"
                     style="margin-bottom: 10px; visibility: {% if pilot_icon_url == '-' %}hidden{% else %}visible{% endif %};"
                />

                <img id="pilot-org-icon"
                     src="{{ pilot_org_icon_url if pilot_org_icon_url != '-' else '' }}"
                     alt="Org icon"
                     width="100"
                     height="100"
                     style="visibility: {% if pilot_org_icon_url == '-' %}hidden{% else %}visible{% endif %};"
                />
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <div><strong>Player:</strong> <span id="pilot-name">{{ pilot_name }}</span></div>

                <div id="pilot-org-wrapper" style="{% if pilot_org_name == '-' %}display:none;{% endif %}">
                    <strong>Org:</strong> <span id="pilot-org">{% if pilot_org_name != '-' %}{{ pilot_org_name }}{% endif %}</span>
                </div>

                <div>
                    <span class="stat-block" id="pilot-kills-block">
                      <strong id="month">{{ player_month_statistics.month }} Kills:</strong>
                      <span id="pilot-kills">{{ player_month_statistics.kills }}</span>
                    </span>

                    <span class="stat-block" id="pilot-deaths-block">
                      <strong>Deaths:</strong>
                      <span id="pilot-deaths">{{ player_month_statistics.deaths }}</span>
                    </span>

                    <span class="stat-block" id="pilot-suicides-block">
                      <strong>Suicides:</strong>
                      <span id="pilot-suicides">{{ player_month_statistics.suicides }}</span>
                    </span>

                    <span class="stat-block" id="pilot-kdr-block">
                      <strong>KDR:</strong>
                      <span id="pilot-kdr">{{ player_month_statistics.kdr }}</span>
                    </span>
                </div>

                <div id="ship-name-wrapper" style="{% if ship_name == '-' %}display:none;{% endif %}">
                    <strong>Ship Name:</strong> <span id="ship-name">{% if ship_name != '-' %}{{ ship_name }}{% endif %}</span>
                </div>
                <div><strong>Game Mode:</strong> <span id="game-mode">{{ game_mode }}</span></div>
            </div>
        </div>
        </div>

        <div class="status-card">
            <div class="slide_btn">
                <span>Bot Push</span>
                <label class="switch">
                    <input type="checkbox" id="botToggle"  class="toggle" data-title-enable="Enable Push To Discord BOT" data-title-disable="Disable Push To Discord BOT" {% if client_enabled %} checked {% endif %}>
                    <span class="slider round" title="{{ 'Disable Push To Discord BOT' if client_enabled else 'Enable Push To Discord BOT' }}"></span>
                </label>
            </div>

            <div class="slide_btn">
                <span>Instant Replay</span>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <label class="switch">
                        <input type="checkbox" id="recordTriggerToggle" class="toggle"
                            data-title-enable="Enable Instant Replay"
                            data-title-disable="Disable Instant Replay"
                            {% if trigger_controller_enabled %} checked {% endif %}>
                        <span class="slider round"
                            title="{{ 'Disable Instant Replay' if trigger_controller_enabled else 'Enable Instant Replay' }}"></span>
                    </label>
                    <span id="replay-expand-icon"
                          class="expand-icon {% if not trigger_controller_enabled %}hidden{% endif %}"
                          style="cursor: pointer;"
                    >
                        {% if trigger_controller_enabled %}◀{% else %}▶{% endif %}
                    </span>
                </div>
            </div>

            <div class="slide_btn">
                <span>Overlay</span>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <label class="switch">
                        <input type="checkbox" id="overlayToggle" class="toggle"
                            data-title-enable="Enable Overlay"
                            data-title-disable="Disable Overlay"
                            {% if overlay_enabled %} checked {% endif %}>
                        <span class="slider round"
                            title="{{ 'Disable Overlay' if overlay_enabled else 'Enable Overlay' }}"></span>
                    </label>
                    <span id="overlay-expand-icon"
                          class="expand-icon {% if not overlay_enabled %}hidden{% endif %}"
                          style="cursor: pointer;"
                    >
                        {% if trigger_controller_enabled %}◀{% else %}▶{% endif %}
                    </span>
                </div>
            </div>

<!--            <div class="slide_btn">-->
<!--                <span>Overlay</span>-->
<!--                <label class="switch">-->
<!--                    <input type="checkbox" id="overlayToggle" class="toggle" data-title-enable="Enable Overlay" data-title-disable="Disable Overlay" {% if overlay_enabled %} checked {% endif %}>-->
<!--                    <span class="slider round" title="{{ 'Disable Overlay' if overlay_enabled else 'Enable Overlay' }}"></span>-->
<!--                </label>-->
<!--            </div>-->

            <div class="slide_btn">
                <span>Verbose Logging</span>
                <label class="switch">
                    <input type="checkbox" id="verboseLoggingToggle" class="toggle" data-title-enable="Enable Verbose Logging" data-title-disable="Disable Verbose Logging" {% if verbose_logging %} checked {% endif %}>
                    <span class="slider round" title="{{ 'Disable Verbose Logging' if verbose_logging else 'Enable Verbose Logging' }}"></span>
                </label>
            </div>

<!-- IGNORE CRASH KILLS/DEADS  -->
            <div class="slide_btn">
                <span>Crash Tracking Off</span>
                <label class="switch">
                    <input type="checkbox" id="verboseLoggingToggle" class="toggle" data-title-enable="Untrack Crash Kills/Deads" data-title-disable="Track Crash Kills/Deads" {% if verbose_logging %} checked {% endif %}>
                    <span class="slider round" title="{{ 'Untrack Crash Kills/Deads' if verbose_logging else 'Track Crash Kills/Deads' }}"></span>
                </label>
            </div>


            <hr class="section-divider">

            <div class="status-card-content">

                <div class="status-center-block">
                    <div><strong>Game Running:</strong>
                        <span id="game-indicator" class="{{ 'green-circle' if game_is_running else 'red-circle' }}"
                              title="Last checked: {{ game_is_running_last_checked }}">
                        </span>
                    </div>
                    <div><strong>LogFile Scanner:</strong>
                        <span id="status-indicator"
                              class="{{ 'green-circle' if logfile_date else 'red-circle' }}"
                              title="Reading every {{logfile_frequency}}s, last: {{logfile_date}}">
                        </span>
                    </div>
                    <div>
                        <span class="stat-block" id="recordings-qty-block">
                            <strong>Instant Replay Videos:</strong>
                            <span id="recordings-qty" title="{{latest_recordings[0] if latest_recordings else 'No recordings found'}}">
                                {{recordings_qty}}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div id="recording-control-panel" style="display: none;">


            <div style="margin-bottom: 10px;"><strong>Instant Replay Options:</strong></div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px;">
                <div class="slide_btn"><span>Suicide Death</span><label class="switch"><input type="checkbox" id="recordings-suicide-toggle" {% if recording_controller.record_suicide %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Own Death</span><label class="switch"><input type="checkbox" id="recordings-own-death-toggle" {% if recording_controller.record_own_death %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>PU</span><label class="switch"><input type="checkbox" id="recordings-pu-toggle" {% if recording_controller.record_pu %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Gun Rush</span><label class="switch"><input type="checkbox" id="recordings-gun-rush-toggle" {% if recording_controller.record_gun_rush %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Squadron Battle</span><label class="switch"><input type="checkbox" id="recordings-squadron-battle-toggle" {% if recording_controller.record_squadron_battle %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Arena Commander</span><label class="switch"><input type="checkbox" id="recordings-arena-commander-toggle" {% if recording_controller.record_arena_commander %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Classic Race</span><label class="switch"><input type="checkbox" id="recordings-classic-race-toggle" {% if recording_controller.record_classic_race %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Battle Royale</span><label class="switch"><input type="checkbox" id="recordings-battle-royale-toggle" {% if recording_controller.record_battle_royale %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Free Flight</span><label class="switch"><input type="checkbox" id="recordings-free-flight-toggle" {% if recording_controller.record_free_flight %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Pirate Swarm</span><label class="switch"><input type="checkbox" id="recordings-pirate-swarm-toggle" {% if recording_controller.record_pirate_swarm %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Vanduul Swarm</span><label class="switch"><input type="checkbox" id="recordings-vanduul-swarm-toggle" {% if recording_controller.record_vanduul_swarm %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Other Modes</span><label class="switch"><input type="checkbox" id="recordings-other-toggle" {% if recording_controller.record_other %} checked {% endif %}><span class="slider round"></span></label></div>
            </div>
        </div>

        <div id="overlay-control-panel" style="display: none;">


            <div style="margin-bottom: 10px;"><strong>Overlay Options:</strong></div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px;">
                <div class="slide_btn"><span>Suicide Death</span><label class="switch"><input type="checkbox" id="overlay-suicide-toggle" {% if overlay.on_suicide %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Own Death</span><label class="switch"><input type="checkbox" id="overlay-own-death-toggle" {% if overlay.on_own_death %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>PU</span><label class="switch"><input type="checkbox" id="overlay-pu-toggle" {% if overlay.on_pu %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Gun Rush</span><label class="switch"><input type="checkbox" id="overlay-gun-rush-toggle" {% if overlay.on_gun_rush %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Squadron Battle</span><label class="switch"><input type="checkbox" id="overlay-squadron-battle-toggle" {% if overlay.on_squadron_battle %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Arena Commander</span><label class="switch"><input type="checkbox" id="overlay-arena-commander-toggle" {% if overlay.on_arena_commander %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Classic Race</span><label class="switch"><input type="checkbox" id="overlay-classic-race-toggle" {% if overlay.on_classic_race %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Battle Royale</span><label class="switch"><input type="checkbox" id="overlay-battle-royale-toggle" {% if overlay.on_battle_royale %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Free Flight</span><label class="switch"><input type="checkbox" id="overlay-free-flight-toggle" {% if overlay.on_free_flight %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Pirate Swarm</span><label class="switch"><input type="checkbox" id="overlay-pirate-swarm-toggle" {% if overlay.on_pirate_swarm %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Vanduul Swarm</span><label class="switch"><input type="checkbox" id="overlay-vanduul-swarm-toggle" {% if overlay.on_vanduul_swarm %} checked {% endif %}><span class="slider round"></span></label></div>
                <div class="slide_btn"><span>Other Modes</span><label class="switch"><input type="checkbox" id="overlay-other-toggle" {% if overlay.on_other %} checked {% endif %}><span class="slider round"></span></label></div>
            </div>
        </div>

    </div>

    <div class="events-table-container">
        <table id="message-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Victim</th>
                    <th>Org</th>
                    <th>Death Zone</th>
                    <th>Killer</th>
                    <th>Org</th>
                    <th>Ship Name</th>
                    <th>Using</th>
                    <th>Damage</th>
                    <th>Game Mode</th>
                    <th>BOT Push</th>
                </tr>
            </thead>
            <tbody id="message-container">
                {% for player_event in player_events %}
                <tr>
                    <td>{{ player_event.date }}</td>
                    <td class="tooltip-cell">
                      <span class="tooltip-trigger">
                        <a href="https://robertsspaceindustries.com/en/citizens/{{ player_event.victim_profile.name }}">
                          {{ player_event.victim_profile.name }}
                        </a>
                      </span>

                      {% if player_event.victim_profile.icon_url != '-'
                            or player_event.victim_profile.enlisted_date != '-'
                            or player_event.victim_profile.location != '-' %}
                        <div class="tooltip-content">
                          {% if player_event.victim_profile.icon_url != '-' %}
                            <img src="{{ player_event.victim_profile.icon_url }}" alt="Player icon" width="128" height="128" />
                          {% endif %}

                            <div><strong>Player:</strong> {{ player_event.victim_profile.name }}</div>

                          {% if player_event.victim_profile.enlisted_date != '-' %}
                            <div><strong>Enlisted:</strong> {{ player_event.victim_profile.enlisted_date }}</div>
                          {% endif %}

                          {% if player_event.victim_profile.location != '-' %}
                            <div><strong>Location:</strong> {{ player_event.victim_profile.location }}</div>
                          {% endif %}

                          {% if player_event.victim_profile.fluency != '-' %}
                            <div><strong>Fluency:</strong> {{ player_event.victim_profile.fluency }}</div>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>

                    <td class="tooltip-cell">
                      {% if player_event.victim_profile.org.name != '-' and player_event.victim_profile.org.name != '-R-' %}
                          <span class="tooltip-trigger">
                            <a href="{{ player_event.victim_profile.org.icon_url }}">
                                {{ player_event.victim_profile.org.name }}
                            </a>
                          </span>
                      {% else %}
                        {{ player_event.victim_profile.org.name }}

                      {% endif %}

                      {% if player_event.victim_profile.org.name == '-R-' %}
                        <div class="tooltip-content">
                          {% if player_event.victim_profile.org.icon_url != '-' %}
                            <img src="{{ player_event.victim_profile.org.icon_url }}" alt="Player icon" width="128" height="128" />
                          {% endif %}

                        </div>
                      {% endif %}

                      {% if player_event.victim_profile.org.url != '-' %}
                        <div class="tooltip-content">
                          {% if player_event.victim_profile.org.icon_url != '-' %}
                            <img src="{{ player_event.victim_profile.org.icon_url }}" alt="Player icon" width="128" height="128" />
                            <div><strong>Org:</strong> {{ player_event.victim_profile.org.name }}</div>
                          {% endif %}

                          {% if player_event.victim_profile.org.rank != '-' %}
                            <div><strong>Rank:</strong> {{ player_event.victim_profile.org.rank }}</div>
                          {% endif %}

                        </div>
                      {% endif %}
                    </td>

                    <td>{{ player_event.victim_zone_name }}</td>

                    <td class="tooltip-cell">
                      <span class="tooltip-trigger">
                        <a href="https://robertsspaceindustries.com/en/citizens/{{ player_event.killer_profile.name }}">
                          {{ player_event.killer_profile.name }}
                        </a>
                      </span>

                      {% if player_event.killer_profile.icon_url != '-'
                            or player_event.killer_profile.enlisted_date != '-'
                            or player_event.killer_profile.location != '-' %}
                        <div class="tooltip-content">
                          {% if player_event.killer_profile.icon_url != '-' %}
                            <img src="{{ player_event.killer_profile.icon_url }}" alt="Player icon" width="128" height="128" />
                          {% endif %}

                            <div><strong>Player:</strong> {{ player_event.killer_profile.name }}</div>

                          {% if player_event.killer_profile.enlisted_date != '-' %}
                            <div><strong>Enlisted:</strong> {{ player_event.killer_profile.enlisted_date }}</div>
                          {% endif %}

                          {% if player_event.killer_profile.location != '-' %}
                            <div><strong>Location:</strong> {{ player_event.killer_profile.location }}</div>
                          {% endif %}

                          {% if player_event.killer_profile.fluency != '-' %}
                            <div><strong>Fluency:</strong> {{ player_event.killer_profile.fluency }}</div>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>

                    <td class="tooltip-cell">
                      {% if player_event.killer_profile.org.name != '-' and player_event.killer_profile.org.name != '-R-' %}
                          <span class="tooltip-trigger">
                            <a href="{{ player_event.killer_profile.org.url }}">
                                {{ player_event.killer_profile.org.name }}
                            </a>
                          </span>
                      {% else %}
                        {{ player_event.killer_profile.org.name }}

                      {% endif %}

                      {% if player_event.killer_profile.org.name == '-R-' %}
                        <div class="tooltip-content">
                          {% if player_event.killer_profile.org.icon_url != '-' %}
                            <img src="{{ player_event.killer_profile.org.icon_url }}" alt="Player icon" width="128" height="128" />
                          {% endif %}

                        </div>
                      {% endif %}

                      {% if player_event.killer_profile.org.url != '-' %}
                        <div class="tooltip-content">
                          {% if player_event.killer_profile.org.icon_url != '-' %}
                            <img src="{{ player_event.killer_profile.org.icon_url }}" alt="Org icon" width="128" height="128" />
                            <div><strong>Org:</strong> {{ player_event.killer_profile.org.name }}</div>
                          {% endif %}

                          {% if player_event.killer_profile.org.rank != '-' %}
                            <div><strong>Rank:</strong> {{ player_event.killer_profile.org.rank }}</div>
                          {% endif %}

                        </div>
                      {% endif %}
                    </td>

                    <td>{{ player_event.ship_name }}</td>
                    <td>{{ player_event.using }}</td>
                    <td>{{ player_event.damage }}</td>
                    <td>{{ player_event.game_mode }}</td>
                    <td>
                        {% if not player_event.client_enabled %}
                            <span class="blue-circle" title="{{ player_event.push_result_message }}"></span>
                        {% else %}
                            <span class="{{ 'green-circle' if player_event.push_result_is_success else 'red-circle' }}"
                                  title="{{ player_event.push_result_message }}"></span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <p>Startup Date: {{startup_date}}</p>
    <p>Version: {{version}}</p>

    <script>
        function flashElement(el, color) {
            const className = `flash-${color}-border`;
            el.classList.add(className);
            setTimeout(() => {
                el.classList.remove(className);
            }, 2500);
        }

        const socket = new WebSocket("{{ ws_url }}");
        const messageContainer = document.getElementById("message-container");
        const gameIndicator = document.getElementById("game-indicator");
        const statusIndicator = document.getElementById("status-indicator");
        const recordingsQuantity = document.getElementById("recordings-qty");

        const pilotName = document.getElementById("pilot-name");
        const pilotOrg = document.getElementById("pilot-org");


        const pilotKills = document.getElementById("pilot-kills");
        const pilotDeaths = document.getElementById("pilot-deaths");
        const pilotSuicides = document.getElementById("pilot-suicides");
        const pilotKdr = document.getElementById("pilot-kdr");

        const shipName = document.getElementById("ship-name");
        const gameMode = document.getElementById("game-mode");

        const logFileDate = document.getElementById("log-file-date");
        const logFileDateText = document.getElementById("log-file-date-text");
        const messageCounter = document.getElementById("message-counter");
        const messageErrorCounter = document.getElementById("message-error-counter");
        const maxEntries = {{ max_entries }};
        const rsi_url = 'https://robertsspaceindustries.com/en/citizens/'

        let messageTimeout = setTimeout(() => {
            statusIndicator.classList.remove("green-circle");
            statusIndicator.classList.add("red-circle");
            }, {{ logfile_frequency }} * 1000)

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);

            // [PILOT NAME]
            if (message.hasOwnProperty('player_profile')) {
                console.log(message)

                const pilotIcon = document.getElementById("pilot-icon");
                if (message.player_profile.icon_url && message.player_profile.icon_url !== "-") {
                    pilotIcon.src = message.player_profile.icon_url;
                    pilotIcon.style.visibility = "visible";
                } else {
                    pilotIcon.src = "";
                    pilotIcon.style.visibility = "hidden";
                }

                const pilotOrgIcon = document.getElementById("pilot-org-icon");
                if (message.player_profile.org.icon_url && message.player_profile.org.icon_url !== "-") {
                    pilotOrgIcon.src = message.player_profile.org.icon_url;
                    pilotOrgIcon.style.visibility = "visible";
                } else {
                    pilotOrgIcon.src = "";
                    pilotOrgIcon.style.visibility = "hidden";
                }

                pilotName.textContent = message.player_profile.name

                const pilotOrgWrapper = document.getElementById("pilot-org-wrapper");
                const newOrg = message.player_profile.org.name;
                if (newOrg && newOrg !== "-") {
                    pilotOrg.textContent = newOrg;
                    pilotOrgWrapper.style.display = "block";
                } else {
                    pilotOrg.textContent = "";
                    pilotOrgWrapper.style.display = "none";
                }

                if (pilotKills.textContent !== String(message.player_statistics.kills)) {
                    pilotKills.textContent = message.player_statistics.kills;
                    flashElement(document.getElementById('pilot-kills-block'), 'green');
                }

                if (pilotDeaths.textContent !== String(message.player_statistics.deaths)) {
                    pilotDeaths.textContent = message.player_statistics.deaths;
                    flashElement(document.getElementById('pilot-deaths-block'), 'red');
                }

                if (pilotSuicides.textContent !== String(message.player_statistics.suicides)) {
                    pilotSuicides.textContent = message.player_statistics.suicides;
                    flashElement(document.getElementById('pilot-suicides-block'), 'blue');
                }

                if (pilotKdr.textContent !== Number(message.player_statistics.kdr).toFixed(2)) {
                    pilotKdr.textContent = Number(message.player_statistics.kdr).toFixed(2);
                    flashElement(document.getElementById('pilot-kdr-block'), 'orange');
                }

                const shipNameWrapper = document.getElementById("ship-name-wrapper");
                const newShipName = message.ship_name;
                if (newShipName && newShipName !== "-") {
                    shipName.textContent = newShipName;
                    shipNameWrapper.style.display = "block";
                } else {
                    shipName.textContent = "";
                    shipNameWrapper.style.display = "none";
                }

                gameMode.textContent = message.game_mode

            }

            // [GAME EXECUTABLE]
            if (message.hasOwnProperty('game_is_running')) {
                gameIndicator.title = message.msg

                if (message.game_is_running) {
                    gameIndicator.classList.remove("red-circle");
                    gameIndicator.classList.add("green-circle");
                }
                else {
                    gameIndicator.classList.remove("green-circle");
                    gameIndicator.classList.add("red-circle");
                }
            }

            // [RECORDINGS]
            if (message.hasOwnProperty('recordings_qty')) {
                if (recordingsQuantity.textContent !== String(message.recordings_qty)) {
                    recordingsQuantity.textContent = message.recordings_qty;
                    recordingsQuantity.title = message.latest_video_filename;
                    flashElement(document.getElementById('recordings-qty-block'), 'blue');
                }
            }

            // [LOGFILE SCANNER]
            if (message.hasOwnProperty('logfile_msg')) {
                statusIndicator.title = message.logfile_msg

                if (message.logfile_scanner_is_running) {

                    clearTimeout(messageTimeout);
                    statusIndicator.classList.remove("red-circle");
                    statusIndicator.classList.add("green-circle");

                    messageTimeout = setTimeout(() => {
                        statusIndicator.classList.remove("green-circle");
                        statusIndicator.classList.add("red-circle");
                        }, message.logfile_frequency * 1000 + 1000);
                }
                else {
                    statusIndicator.classList.remove("green-circle");
                    statusIndicator.classList.add("red-circle");
                }
            };

            // [PLAYER EVENT]
            if (message.hasOwnProperty('uuid')) {
                console.log(message)
                const tableRows = messageContainer.getElementsByTagName("tr");

			    while (tableRows.length >= maxEntries) {
                    messageContainer.removeChild(messageContainer.lastChild);
                }

				const tableRow = document.createElement("tr");
				const dateCell = document.createElement("td");

                const victimPlayerTD = createPlayerTooltipTD(
                    message.victim_profile.name,
                    message.victim_profile.icon_url,
                    message.victim_profile.enlisted_date,
                    message.victim_profile.location,
                    message.victim_profile.fluency
                );

                const victimOrgTD = createPlayerOrgTooltipTD(
                message.victim_profile.org.name,
                message.victim_profile.org.url,
                message.victim_profile.org.icon_url,
                message.victim_profile.org.rank
                );

                const killedByTD = createPlayerTooltipTD(
                    message.killer_profile.name,
                    message.killer_profile.icon_url,
                    message.killer_profile.enlisted_date,
                    message.killer_profile.location,
                    message.killer_profile.fluency

                );

                const killedByOrgTD = createPlayerOrgTooltipTD(
                message.killer_profile.org.name,
                message.killer_profile.org.url,
                message.killer_profile.org.icon_url,
                message.killer_profile.org.rank
                );

				const victimZoneCell = document.createElement("td");
				const shipCell = document.createElement("td");
				const usingCell = document.createElement("td");
				const damageCell = document.createElement("td");
				const gameModeCell = document.createElement("td");

				const botPushCell = document.createElement("td");
				const botPushSpanCell = document.createElement("span");
				botPushSpanCell.title = message.push_result_message

                if (!message.client_enabled) {
                    botPushSpanCell.classList.add("blue-circle")
                }
				else if (message.push_result_is_success) {
				    botPushSpanCell.classList.add("green-circle")
				} else {
				    botPushSpanCell.classList.add("red-circle")
				}
				botPushCell.append(botPushSpanCell)

                dateCell.textContent = message.date;
                victimZoneCell.textContent = message.victim_zone_name;
                shipCell.textContent = message.ship_name;

				usingCell.textContent = message.using;
				damageCell.textContent = message.damage;
				gameModeCell.textContent = message.game_mode;

				tableRow.appendChild(dateCell);
				tableRow.appendChild(victimPlayerTD);
				tableRow.appendChild(victimOrgTD);
				tableRow.appendChild(victimZoneCell);

				tableRow.appendChild(killedByTD);
				tableRow.appendChild(killedByOrgTD);
                tableRow.appendChild(shipCell);
                tableRow.appendChild(usingCell);
                tableRow.appendChild(damageCell);
				tableRow.appendChild(gameModeCell);

				tableRow.appendChild(botPushCell);

				tableRow.classList.add("transition-background");

                messageContainer.insertBefore(tableRow, messageContainer.firstChild);
                void tableRow.offsetWidth;

				setTimeout(function() {
					tableRow.classList.add("green");
				}, 100);

				setTimeout(function() {
					tableRow.classList.remove("green");
				}, 8100);
			};
        };

    const fetchData = (endpoint) => {
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                console.log(data)
            })
            .catch(error => console.error('Error toggling BOT status:', error));
    }

    document.getElementById('botToggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/client/enable' : '/client/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordTriggerToggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/trigger_controller/enable' : '/trigger_controller/disable';
        fetchData(endpoint)
    });


    // [OVERLAY]
    document.getElementById('overlayToggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/enable' : '/overlay/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-suicide-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/suicide/enable' : '/overlay/suicide/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-own-death-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/own_death/enable' : '/overlay/own_death/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-pu-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/pu/enable' : '/overlay/pu/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-gun-rush-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/gun_rush/enable' : '/overlay/gun_rush/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-squadron-battle-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/squadron_battle/enable' : '/overlay/squadron_battle/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-arena-commander-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/arena_commander/enable' : '/overlay/arena_commander/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-classic-race-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/classic_race/enable' : '/overlay/classic_race/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-battle-royale-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/battle_royale/enable' : '/overlay/battle_royale/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-free-flight-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/free_flight/enable' : '/overlay/free_flight/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-pirate-swarm-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/pirate_swarm/enable' : '/overlay/pirate_swarm/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-vanduul-swarm-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/vanduul_swarm/enable' : '/overlay/vanduul_swarm/disable';
        fetchData(endpoint)
    });

    document.getElementById('overlay-other-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/overlay/other/enable' : '/overlay/other/disable';
        fetchData(endpoint)
    });

    // [LOGGING]

    document.getElementById('verboseLoggingToggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/verbose_logging/enable' : '/verbose_logging/disable';
        fetchData(endpoint)
    });

    // [RECORDING CONTROLLER]

    document.getElementById('recordings-suicide-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/suicide/enable' : '/recordings_controller/suicide/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-own-death-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/own_death/enable' : '/recordings_controller/own_death/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-pu-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/pu/enable' : '/recordings_controller/pu/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-gun-rush-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/gun_rush/enable' : '/recordings_controller/gun_rush/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-squadron-battle-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/squadron_battle/enable' : '/recordings_controller/squadron_battle/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-arena-commander-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/arena_commander/enable' : '/recordings_controller/arena_commander/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-classic-race-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/classic_race/enable' : '/recordings_controller/classic_race/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-battle-royale-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/battle_royale/enable' : '/recordings_controller/battle_royale/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-free-flight-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/free_flight/enable' : '/recordings_controller/free_flight/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-pirate-swarm-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/pirate_swarm/enable' : '/recordings_controller/pirate_swarm/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-vanduul-swarm-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/vanduul_swarm/enable' : '/recordings_controller/vanduul_swarm/disable';
        fetchData(endpoint)
    });

    document.getElementById('recordings-other-toggle').addEventListener('change', function() {
        const endpoint = this.checked ? '/recordings_controller/other/enable' : '/recordings_controller/other/disable';
        fetchData(endpoint)
    });

    </script>

        <script>
        function createPlayerOrgTooltipTD(orgName, orgUrl, iconUrl, rank) {
        const td = document.createElement("td");
        td.classList.add("tooltip-cell");

        const span = document.createElement("span");
        span.classList.add("tooltip-trigger");

        if (orgUrl !== '-' && orgName !== '-R-') {
            const link = document.createElement("a");
            link.href = orgUrl;
            link.textContent = orgName;
            span.appendChild(link);
        } else  {

            span.textContent = orgName;
        }

        td.appendChild(span);

        const shouldShowTooltip =
            (orgName === '-R-' && iconUrl !== '-') ||
            (orgUrl !== '-' || rank !== '-');

        if (shouldShowTooltip) {
            const tooltipDiv = document.createElement("div");
            tooltipDiv.classList.add("tooltip-content");

            if (iconUrl !== '-') {
                const img = document.createElement("img");
                img.src = iconUrl;
                img.alt = "Org icon";
                img.width = 128;
                img.height = 128;
                tooltipDiv.appendChild(img);
            }

            if (orgName !== '-') {
                const nameDiv = document.createElement("div");
                nameDiv.innerHTML = `<strong>Org:</strong> ${orgName}`;
                tooltipDiv.appendChild(nameDiv);
            }

            if (rank !== '-') {
                const rankDiv = document.createElement("div");
                rankDiv.innerHTML = `<strong>Rank:</strong> ${rank}`;
                tooltipDiv.appendChild(rankDiv);
            }

            td.appendChild(tooltipDiv);
        }

        return td;
    }
    </script>

    <script>
        function createPlayerTooltipTD(playerName, iconUrl, enlistedDate, location, fluency) {
        const td = document.createElement("td");
        td.classList.add("tooltip-cell");

        const span = document.createElement("span");
        span.classList.add("tooltip-trigger");

        const link = document.createElement("a");
        link.href = `${rsi_url}${playerName}`;
        link.textContent = playerName;
        span.appendChild(link);
        td.appendChild(span);

        const shouldShowTooltip = iconUrl !== '-' || enlistedDate !== '-' || location !== '-' || fluency !== '-';
        if (shouldShowTooltip) {
            const tooltipDiv = document.createElement("div");
            tooltipDiv.classList.add("tooltip-content");

            if (iconUrl !== '-') {
                const img = document.createElement("img");
                img.src = iconUrl;
                img.alt = "Player icon";
                img.width = 128;
                img.height = 128;
                tooltipDiv.appendChild(img);
            }

            if (playerName !== '-') {
                const playerNameInfo = document.createElement("div");
                playerNameInfo.innerHTML = `<strong>Player:</strong> ${playerName}`;
                tooltipDiv.appendChild(playerNameInfo);
            }

            if (enlistedDate !== '-') {
                const enlistInfo = document.createElement("div");
                enlistInfo.innerHTML = `<strong>Enlisted:</strong> ${enlistedDate}`;
                tooltipDiv.appendChild(enlistInfo);
            }

            if (location !== '-') {
                const locationInfo = document.createElement("div");
                locationInfo.innerHTML = `<strong>Location:</strong> ${location}`;
                tooltipDiv.appendChild(locationInfo);
            }

            if (fluency !== '-') {
                const fluencyInfo = document.createElement("div");
                fluencyInfo.innerHTML = `<strong>Fluency:</strong> ${fluency}`;
                tooltipDiv.appendChild(fluencyInfo);
            }

            td.appendChild(tooltipDiv);
        }

        return td;
    }
    </script>

    <script>
        document.querySelectorAll('.tooltip-cell').forEach(cell => {
            const trigger = cell.querySelector('.tooltip-trigger');
            const tooltip = cell.querySelector('.tooltip-content');

            if (!tooltip || !trigger) return;

            cell.addEventListener('mouseenter', () => {
                const rect = tooltip.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;

                tooltip.classList.remove('tooltip-top', 'tooltip-bottom');

                // Decide where to place the tooltip
                if (spaceBelow < 200 && spaceAbove > 200) {
                    tooltip.classList.add('tooltip-top');
                } else {
                    tooltip.classList.add('tooltip-bottom');
                }
            });
        });
    </script>

    <script>
        document.querySelectorAll('.toggle').forEach((checkbox) => {
            const sliderSpan = checkbox.nextElementSibling;
            const titleEnable = checkbox.dataset.titleEnable;
            const titleDisable = checkbox.dataset.titleDisable;

            function updateTitle() {
                sliderSpan.title = checkbox.checked ? titleDisable : titleEnable;
            }

            checkbox.addEventListener('change', updateTitle);
            updateTitle();
        });
    </script>

    <script>
        const recordingToggle = document.getElementById("recordTriggerToggle");
        const recordingPanel = document.getElementById("recording-control-panel");
        const expandIcon = document.getElementById("replay-expand-icon");

        function updateExpandIconState() {
            if (recordingToggle.checked) {
                expandIcon.classList.remove("hidden");
                expandIcon.textContent = "▶"; // Always collapsed by default
            } else {
                expandIcon.classList.add("hidden");
                recordingPanel.style.display = "none";
            }
        }

        // Backend toggle only
        recordingToggle.addEventListener("change", function () {
            const endpoint = this.checked ? '/trigger_controller/enable' : '/trigger_controller/disable';
            fetch(endpoint).then(r => r.json()).then(data => console.log(data)).catch(console.error);

            updateExpandIconState();
        });

        expandIcon.addEventListener("click", function () {
            if (expandIcon.classList.contains("hidden")) return;

            const isVisible = recordingPanel.style.display !== "none";

            // Hide overlay panel if it's open
            if (!isVisible) {
                overlayPanel.style.display = "none";
                overlayExpandIcon.textContent = "▶";
            }

            recordingPanel.style.display = isVisible ? "none" : "flex";
            expandIcon.textContent = isVisible ? "▶" : "◀";
        });

        // Initial setup (run once on page load)
        updateExpandIconState();
    </script>

    <script>
        const overlayToggle = document.getElementById("overlayToggle");
        const overlayPanel = document.getElementById("overlay-control-panel");
        const overlayExpandIcon = document.getElementById("overlay-expand-icon");

        function updateOverlayExpandIconState() {
            if (overlayToggle.checked) {
                overlayExpandIcon.classList.remove("hidden");
                overlayExpandIcon.textContent = "▶"; // Always collapsed by default
            } else {
                overlayExpandIcon.classList.add("hidden");
                overlayPanel.style.display = "none";
            }
        }

        // Backend toggle only
        overlayToggle.addEventListener("change", function () {
            const endpoint = this.checked ? '/overlay/enable' : '/overlay/disable';
            fetch(endpoint).then(r => r.json()).then(data => console.log(data)).catch(console.error);

            updateOverlayExpandIconState();
        });

        overlayExpandIcon.addEventListener("click", function () {
            if (overlayExpandIcon.classList.contains("hidden")) return;

            const isVisible = overlayPanel.style.display !== "none";

            // Hide recording panel if it's open
            if (!isVisible) {
                recordingPanel.style.display = "none";
                expandIcon.textContent = "▶";
            }

            overlayPanel.style.display = isVisible ? "none" : "flex";
            overlayExpandIcon.textContent = isVisible ? "▶" : "◀";
        });

        // Initial setup (run once on page load)
        updateOverlayExpandIconState();
    </script>



{% endblock %}